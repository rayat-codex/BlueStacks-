name: avica + win11 + tailscale  # Name is now all lowercase

on:
  workflow_dispatch:

jobs:
  run-avica:
    runs-on: windows-latest
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}

    steps:

    - name: Install Tailscale (silent for all users)
      shell: powershell
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force

    - name: Establish Tailscale Connection
      shell: powershell
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 10) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 5
            $retries++
        }

        if (-not $tsIP) {
            Write-Error "Tailscale IP not assigned. Exiting."
            exit 1
        }

        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

    - name: Install BlueStacks 5 (Nougat 64-bit) via Direct Download
      shell: powershell
      run: |
        # Using a more robust, official download link for the latest BlueStacks 5 installer.
        # This link typically handles redirects better or is more stable.
        $bluestacksUrl = "https://cdn.bluestacks.com/downloads/5.20.101.1002/BlueStacksMicroInstaller_5.20.101.1002_amd64_native.exe" 
        $installerPath = "$env:TEMP\BlueStacksInstaller.exe"
        
        Write-Host "Downloading BlueStacks 5 installer from $bluestacksUrl"
        # Using the -FollowRelocation parameter to handle redirects (302/307 codes)
        Invoke-WebRequest -Uri $bluestacksUrl -OutFile $installerPath -FollowRelocation

        # Run the installer silently.
        Write-Host "Starting silent installation..."
        Start-Process -FilePath $installerPath -ArgumentList "/s" -Wait -PassThru | Out-Null
        
        Write-Host "BlueStacks 5 installation initiated."

        # Wait a reasonable amount of time for the installation to complete.
        Start-Sleep -Seconds 300 # Wait 5 minutes for the installation
        
    - name: Download and run setup.bat from GitLab
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://gitlab.com/MR.English2008/avica/-/raw/main/setup.bat" -OutFile "setup.bat"
        cmd /c setup.bat

    - name: Install Python libraries
      shell: bash
      run: |
        pip install pillow requests

    - name: Run show.bat
      shell: cmd
      run: |
        call show.bat

    - name: Keep runner alive (heartbeat)
      shell: powershell
      run: |
        while ($true) {
          Write-Host (Get-Date -Format "u") " - heartbeat"
          Start-Sleep -Seconds 60
        }
        
